<% if @www_redirect -%>
<VirtualHost *:80>
  ServerName        <% node['apache2-wrapper']['reverseproxy']['site'] -%>
<% node['apache2-wrapper']['reverseproxy']['host_aliases'].each do |a| -%>
  ServerAlias       www.<%= a %>
<% end -%>

  RewriteEngine On
  RewriteCond %{HTTP_HOST} ^www.<%= @host_name %>$ [NC]
  RewriteRule ^/(.*)$ http://<%= @host_name %>/$1 [R=301,L]
</VirtualHost>

<% end -%>
<VirtualHost *:80>
<% if node['apache2-wrapper']['reverseproxy']['ssl'] && node['apache2-wrapper']['reverseproxy']['ssl']['redirect_http'] -%>
  RewriteEngine On
  # rewrite non ssl -> ssl
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
<% end -%>

<%= render '_apache_common.erb' %>

</VirtualHost>

<% if node['apache2-wrapper']['reverseproxy']['ssl'] && node['apache2-wrapper']['reverseproxy']['ssl']['enabled'] -%>
<VirtualHost *:<%= node['apache2-wrapper']['reverseproxy']['ssl']['ssl_listen_ports'].join(' *:') %>>

<%= render '_apache_common.erb' %>

  SSLEngine on
  SSLCertificateFile <%= node['apache2-wrapper']['reverseproxy']['ssl']['cert_path'] %>
  SSLCertificateKeyFile <%= node['apache2-wrapper']['reverseproxy']['ssl']['key_path'] %>
  <% if node['apache2-wrapper']['reverseproxy']['ssl']['ca_cert_path'] -%>
  SSLCACertificateFile <%= node['apache2-wrapper']['reverseproxy']['ssl']['ca_cert_path'] %>
  <% end -%>

</VirtualHost>
<% end -%>
